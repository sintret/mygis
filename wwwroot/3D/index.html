<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link href="./fonts/iconfont.css" rel="stylesheet">
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="./css/index.css" type="text/css" />
		<!--<link rel="stylesheet" href="./fonts/iconfont.css" type="text/css">-->
		<script src="./js/jquery.min.js"></script>
		<script src="./js/interaction.js"></script>
		<link href="Build/Cesium/Widgets/widgets.css" rel="stylesheet">
		<link href="css/pretty.css" rel="stylesheet">
		<script src="libs/SuperMap.Include.js"></script>
		<script src="Build/Cesium/Cesium.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/bootstrap-select.min.js"></script>
		<script src="js/tooltip.js"></script>
		<script src="js/echarts.js"></script>
		<!--<script src="js/require.min.js" data-main="js/main"></script>-->
		<script src="tools/measurement.js"></script>
		<script src="tools/clickDisaster.js"></script>
		<script src="tools/FindNearest.js"></script>
		<script src="tools/profile.js"></script>
		<script src="tools/profile_route.js"></script>
		<script src="tools/bestPath.js"></script>
		<script src="tools/layerControl.js"></script>
		<title>3D</title>
	</head>

	<body id="body">
		<div id="cesiumContainer"></div>
		<div id="mousePosition"></div>
		<div id='loadingbar' class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
		<div id='transform' class="icon-btn ynmap-3d-icons erwei">
		</div>
		<!--<div id='toggle' class="icon-btn ynmap-3d-icons show">
		</div>-->
		<div id='measure' class="icon-btn ynmap-3d-icons measure">
		</div>
		<div id='flood' class="icon-btn ynmap-3d-icons flood">
		</div>
		<div id='profile' class="icon-btn ynmap-3d-icons linestring">
		</div>
		<div id='network' class="icon-btn ynmap-3d-icons routes">
		</div>
		<!--图层控制面板-->
		<div id='layerControl-content'>
			<table class="table table-hover">
				<tr>
					<th>Layers</th>
					<th>Visibility</th>
				</tr>
				<tr>
					<td>Base Map</td>
					<td>
						<div class="layerVisible ynmap-3d-icons show" id="baseMap">
						</div>
					</td>
				</tr>
				<tr>
					<td>Disaster</td>
					<td>
						<div class="layerVisible ynmap-3d-icons show" id="disaster_Layer">
						</div>
					</td>
				</tr>
				<tr>
					<td>Building</td>
					<td>
						<div class="layerVisible ynmap-3d-icons show" id="building">
						</div>
					</td>
				</tr>
				<!--<tr>
					<td>Police Station</td>
					<td>
						<div class="layerVisible ynmap-3d-icons show" id="police">
						</div>
					</td>
				</tr>
				<tr>
					<td>Hospital</td>
					<td>
						<div class="layerVisible ynmap-3d-icons show" id="hospital">
						</div>
					</td>
				</tr>-->
			</table>
		</div>
		<!-- 测量面板 -->
		<div id='measure-content'>
			<div class='measure-type'>
				<div class='text underline'>MEASURE</div>
				<div class="font-btn ynmap-3d-icons distance" id="measure_distance"></div>
				<div class="font-btn ynmap-3d-icons area" id="measure_area"></div>
			</div>
			<div class='measure-mode'>
				<div class='text underline'>MODE</div>
				<div class="font-btn ynmap-3d-icons measure2d active" id="measure2d"></div>
				<div class="font-btn ynmap-3d-icons measure3d" id="measure3d"></div>
			</div>
			<div class='measure-clear'>
				<div class='text underline'>CLEAR</div>
				<div class="font-btn ynmap-3d-icons clear"></div>
			</div>
		</div>
		<!-- 淹没分析面板 -->
		<div id='flood-content'>
			<div class='flood-title'>FLOOD ANALYSIS</div>
			<div class='max-height'>
				<div class='flood-text'>max height(m)</div>
				<div class='flood-input'>
					<input type='text' value="9000" />
				</div>
			</div>
			<div class='min-height'>
				<div class='flood-text'>min height(m)
				</div>
				<div class='flood-input'>
					<input type='text' value="0" />
				</div>
			</div>
			<div class='flood-speed'>
				<div class='flood-text'>flood speed(m/s)
				</div>
				<div class='flood-input'>
					<input type='text' value="100" />
				</div>
			</div>
			<div class='draw-clear'>
				<div class="font-btn ynmap-3d-icons draw"></div>
				<div class="font-btn ynmap-3d-icons clear"></div>
			</div>
		</div>
		<!-- 剖面分析面板 -->
		<div id='profile-content'>
			<div class='measure-type'>
				<div class='text underline'>PROFILE ANALYSIS</div>
				<div class="font-btn ynmap-3d-icons draw" id="profileDraw"></div>
				<div class="font-btn ynmap-3d-icons clear" id="profileClear"></div>
			</div>
		</div>
		<!-- 网络分析面板 -->
		<div id='network-content'>
			<div class='network-title'>BEST PATH ANALYSIS</div>
			<div class='max-height'>
				<div class='network-text'>Select Office SAR & POS SAR</div>
				<div class='network-input'>
					<select id="selectSAR">
						<option value="0">None</option>
					</select>
					<div class="font-btn ynmap-3d-icons draw" id="drawStart"></div>
				</div>
			</div>
			<div class='min-height'>
				<div class='network-text'>Select LKP
				</div>
				<div class='network-input'>
					<select id="selectDisaster">
						<option value="0">None</option>
					</select>
					<div class="font-btn ynmap-3d-icons draw" id="drawEnd"></div>
				</div>
			</div>
			<div class='draw-clear'>
				<div class="font-btn ynmap-3d-icons draw" id="getBestPath"></div>
				<div class="font-btn ynmap-3d-icons clear" id="clearBestPath"></div>
			</div>
		</div>

		<!-- 弹窗 -->
		<!--<div class='pop'>
			<div class="pop-content"></div>
			<div class="pop-arrow">
				<div></div>
			</div>
		</div>-->
		<!--<canvas style="position : absolute; right : 2%; bottom : 2%;background-color:rgba(65, 65, 65, 0.5)" id="pro" height="0" width="0"></canvas>-->
		<div id='echarts'></div>
		
		<script>
			//var url_data = "http://111.231.206.131:8098/iserver/services/data-DisasterInfo/rest/data";
			var url_map = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/DisasterMap";
			var url_SAROffice = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/SARoffice";
			var url_networkCar = "http://igis.basarnas.go.id:8099/iserver/services/transportationAnalyst-map_car/rest/networkanalyst/BuildNetwork_car@Indonesia_car";
			var url_networkMoto = "http://igis.basarnas.go.id:8099/iserver/services/transportationAnalyst-SARData/rest/networkanalyst/BuildNetwork@Indonesia_3857";
			var url_helicopter = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/HELIKOPTER";
			var url_SAROffice = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/SARoffice";
			var url_hospital = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/hospital";
			var url_police = "http://igis.basarnas.go.id:8099/iserver/services/map-SARData/rest/maps/police";
			var url_terrain = "http://igis.basarnas.go.id:8099/iserver/services/spatialAnalysis-Indonesiaterrain/restjsr/spatialanalyst/geometry/3d/extractvector3d.json?returnContent=true";
			//var url_police = "http://111.231.206.131:8098/0xibe64c/iserver/services/map-hospital_police/rest/maps/police";
			//var url_hospital = "http://111.231.206.131:8098/0xibe64c/iserver/services/map-hospital_police/rest/maps/hospital";
			var viewer;
			var myChart = echarts.init(document.getElementById('echarts'), 'dark');
			var buildingLayer;
			var imagery_mec;
			var policeLayer;
			var hospitalLayer;
			var baseMapLayer;
			var handlerDis, handlerArea;
			var findNearestType = 'SAR';
			var facilityPoints = [];
			$(function() {
				$('#transform').click(function() {
					$('#layerControl-content').toggle();
					$('#flood-content').hide();
					$('#profile-content').hide();
					$('#network-content').hide();
					$("#measure-content").hide();

				});
				$('#toggle').click(function() {
					toggleEye();
					$('#layerControl-content').hide();
					$('#flood-content').hide();
					$('#profile-content').hide();
					$('#network-content').hide();
				});
				$('#flood').click(function() {
					$('#flood-content').toggle();
					$('#layerControl-content').hide();
					$('#profile-content').hide();
					$('#network-content').hide();
					$("#measure-content").hide();
				});
				$('#profile').click(function() {

					$('#profile-content').toggle();
					$('#flood-content').hide();
					$('#layerControl-content').hide();
					$('#network-content').hide();
					$("#measure-content").hide();
				});

				$('#network').click(function() {
					$('#network-content').toggle();
					$('#profile-content').hide();
					$('#flood-content').hide();
					$('#layerControl-content').hide();
					$("#measure-content").hide();
				});

				$('#measure').click(function() {
					$('#network-content').toggle();
					$('#profile-content').hide();
					$('#flood-content').hide();
					$('#layerControl-content').hide();

					handlerDis = new Cesium.MeasureHandler(viewer, Cesium.MeasureMode.Distance, 0);
					//注册测距功能事件
					handlerDis.measureEvt.addEventListener(function(result) {
						var dis = Number(result.distance);
						var distance = dis > 1000 ? (dis / 1000).toFixed(2) + 'km' : dis.toFixed(2) + 'm';
						handlerDis.disLabel.text = 'Distance: ' + distance;
					});
					handlerDis.activeEvt.addEventListener(function(isActive) {
						if(isActive == true) {
							viewer.enableCursorStyle = false;
							viewer._element.style.cursor = '';
							$('body').removeClass('measureCur').addClass('measureCur');
						} else {
							viewer.enableCursorStyle = true;
							$('body').removeClass('measureCur');
						}
					});
					//初始化测量面积
					handlerArea = new Cesium.MeasureHandler(viewer, Cesium.MeasureMode.Area, 0);
					handlerArea.measureEvt.addEventListener(function(result) {
						var mj = Number(result.area);
						var area = mj > 1000000 ? (mj / 1000000).toFixed(2) + 'km²' : mj.toFixed(2) + 'm²'
						handlerArea.areaLabel.text = 'Area: ' + area;
					});
					handlerArea.activeEvt.addEventListener(function(isActive) {
						if(isActive == true) {
							viewer.enableCursorStyle = false;
							viewer._element.style.cursor = '';
							$('body').removeClass('measureCur').addClass('measureCur');
						} else {
							viewer.enableCursorStyle = true;
							$('body').removeClass('measureCur');
						}
					});
				});
				$('#measure-content .font-btn').click(function() {
					toggleMeasureMode($(this));
				});
				$('#flood-content .font-btn').click(function() {
					drawFlood($(this));
				});
				//初始化viewer部件

				viewer = new Cesium.Viewer('cesiumContainer', {
					//添加STK World Terrain地形服务
					terrainProvider: new Cesium.CesiumTerrainProvider({
						url: "https://www.supermapol.com/realspace/services/3D-stk_terrain/rest/realspace/datas/info/data/path",
						requestWaterMask: true,
						requestVertexNormals: true
					})
					//https://assets02.agi.com/stk-terrain/world
					//添加BingMaps影像服务
//										imageryProvider: new Cesium.BingMapsImageryProvider({
//											url: 'https://dev.virtualearth.net',
//											mapStyle: Cesium.BingMapsStyle.AERIAL,
//											key: 'ArLWvxLVAh1vxsmDZuOxr94On14sA52a_IPUewEz8H7mm3qDQnjWe-OzJtu1PZpZ'
//										})
				});
				buildingLayer = viewer.scene.addS3MTilesLayerByScp("http://igis.basarnas.go.id:8099/iserver/services/3D-building_jakarta/rest/realspace/datas/building_Jakarta@building/config", {
					name: 'building'
				});
				buildingLayer_all_1 = viewer.scene.addS3MTilesLayerByScp("http://igis.basarnas.go.id:8099/iserver/services/3D-building_indonesia/rest/realspace/datas/building_1@building/config", {
					name: 'building_all_1'
				});
				buildingLayer_all_2 = viewer.scene.addS3MTilesLayerByScp("http://igis.basarnas.go.id:8099/iserver/services/3D-building_indonesia/rest/realspace/datas/building_2@building/config", {
					name: 'building_all_2'
				});
				
				
				
//				buildingLayer_1 = viewer.scene.addS3MTilesLayerByScp("http://111.231.206.131:8099/iserver/services/3D-building/rest/realspace/datas/building_1@building/config", {
//					name: 'building_1'
//				});
//				buildingLayer_2 = viewer.scene.addS3MTilesLayerByScp("http://111.231.206.131:8099/iserver/services/3D-building/rest/realspace/datas/building_2@building/config", {
//					name: 'building_2'
//				});
//				buildingLayer_3 = viewer.scene.addS3MTilesLayerByScp("http://111.231.206.131:8099/iserver/services/3D-building/rest/realspace/datas/building_3@building/config", {
//					name: 'building_3'
//				});
				
				

				//设置相机视角
				viewer.scene.camera.setView({
					destination: new Cesium.Cartesian3.fromDegrees(106.836823171528, -6.21541991512467, 7000),
					orientation: {
						heading: 0,
						pitch: -1.57,
						roll: 0
					}
				});
				$('#loadingbar').hide();

				//添加图层
				var imageryLayers = viewer.imageryLayers;

				//Google底图
				var url_google = "http://mt1.google.cn/vt/lyrs=s&hl=zh-CN&x={x}&y={y}&z={z}&s=Gali";
				var googleProvider = new Cesium.UrlTemplateImageryProvider({
					url: url_google
				});
				baseMapLayer = imageryLayers.addImageryProvider(googleProvider);

				//灾害图层
				var provider_mec = new Cesium.SuperMapImageryProvider({
					url: url_map //墨卡托投影地图服务
				});

				imagery_mec = imageryLayers.addImageryProvider(provider_mec);
				imagery_mec.alpha = 0.8;
				
//				//警察局图层
//				var provider_police = new Cesium.SuperMapImageryProvider({
//					url: url_police //墨卡托投影地图服务
//				});
//
//				policeLayer = imageryLayers.addImageryProvider(provider_police);
//				policeLayer.alpha = 0.8;

				//点击灾害
				clickDisaster();
				var iframe = document.getElementsByClassName('cesium-infoBox-iframe')[0];
				iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-popups allow-forms');

				//剖面分析
				//drawProfile();
				$("#profileDraw").click(drawProfile);

				//最佳路径
				bestPath();

				//图层管理
				layerControl();

			})
		</script>
	</body>

</html>